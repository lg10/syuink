# 测试计划（流程与预期）

## 1. IP 分配并发与回收
- 步骤：同一 group 并发 5 台设备请求连接；记录分配 IP；断开全部再重连。
- 预期：首次连接获得唯一 IP；断开后可回收，再次连接仍唯一；无“IP 用尽”或重复。

## 2. 连接/断开与状态同步
- 步骤：正常连接 -> 观察 `vpn-connected` 事件 -> 停止 -> 观察 `vpn-disconnected`；检查 UI 状态、托盘、路由/代理清理。
- 预期：连接成功显示虚拟 IP 和 SOCKS5 端口；停止后状态回到“未连接”，路由/系统代理关闭。

## 3. 系统代理设置
- Windows：开启/关闭全局代理后读取注册表验证；macOS：使用 `networksetup -getsocksfirewallproxy` 验证。
- 预期：设置成功且状态与 UI 一致；失败时有提示并回滚 UI。

## 4. 服务声明与网关路由
- 步骤：设备 A 发布服务，设备 B 通过虚拟 IP 或 SOCKS5 访问；再发布冲突服务。
- 预期：服务可访问；冲突被拒绝或有明确提示；网关下线后路由清理，访问失败。

## 5. 广播/多播
- 步骤：在子网内发送 mDNS/SSDP；另一端监听。
- 预期：可在远端看到广播；节点下线后广播不再转发。

## 6. SOCKS5 端口回退
- 步骤：占用 1080 后启动客户端。
- 预期：随机端口启动成功；UI 显示实际端口；代理可用。

## 7. 安全与健壮性
- 步骤：发送超长 name/os/version（>256 字符）；对未授权 token 请求 `/wapi/`、`/api/group/:id/allocate_ip`、`/devices`。
- 预期：超长字段被拒或截断不崩溃；未授权请求被拒绝，返回 401/403。

## 8. 平台差异
- Windows：以管理员运行，创建 TUN 成功，UDP/TCP（经 SOCKS5）测试通过。
- macOS：sudo 成功/失败两路径；utun 创建失败时有明确错误提示。

## 9. 健康检查与资源清理
- 步骤：异常终止节点进程；重启后检查路由/代理残留；健康检查接口返回状态。
- 预期：残留已清理或有自愈；健康接口可反映真实状态。