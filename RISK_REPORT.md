# 关键风险与可优化点

## 风险与漏洞
1. **IP 分配一致性**：信令 `/allocate_ip` 仅基于内存扫描，缺少租约/持久化，信令多实例或 DO 状态丢失可能导致重复 IP。
2. **设备元数据缺校验**：`join` 消息的 name/os/version/device_type 无长度/格式验证，存在内存放大、日志注入风险。
3. **服务声明冲突处理简单**：仅按 IP+端口+协议冲突判定，打印/发现类未校验；跨协议端口冲突未覆盖。
4. **SOCKS5 端口回退可见性**：端口占用时回退随机端口，UI 不显示实际端口，用户难以配置代理。
5. **系统代理设置可靠性**：调用 reg/networksetup 后未校验结果，失败时 UI 可能与系统状态不一致。
8. **资源清理/健康检测**：后台任务异常退出时路由/NAT 清理依赖正常路径；缺少自检与健康状态上报。

## 优化建议
- **IP 分配**：为 `/allocate_ip` 增加租约与持久化（或 DO state 保存），下线/超时回收；信令多实例时需集中或分片分配策略。
- **元数据校验**：对 name/os/version/device_type 长度和字符做限制与过滤，拒绝或截断异常输入。
- **服务声明**：严格区分协议+端口冲突，打印/发现类也做格式/长度校验；必要时返回冲突提示。
- **SOCKS5 端口展示**：在 UI 展示实际监听端口（含回退端口），允许用户自定义。
- **系统代理验证**：设置后读取系统当前代理状态，失败时提示并回滚 UI；记录失败日志。
- **权限提示**：sudo 失败时明确要求以管理员/ root 运行，并阻断继续启动。
- **健康与自愈**：前端定期调用健康检查；后端在异常退出时确保路由/代理清理，必要时 watchdog 重启。