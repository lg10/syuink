# Syuink 使用手册与技术文档

## 1. 软件简介
Syuink 是一款基于 Rust 和 Tauri 构建的现代化异地组网（Mesh VPN）与服务共享工具。它旨在打破地理限制，让分散在不同网络环境下的设备（如公司电脑、家中 NAS、云服务器）像在同一个局域网内一样互联互通。

与传统 VPN 不同，Syuink 采用了 **去中心化的分布式服务网格** 架构，无需中心网关，任意设备均可声明并共享其局域网内的服务（如打印机、Web 服务、SSH 等）。

---

## 2. 功能清单

### ✅ 已实现功能

*   **P2P Mesh 组网**:
    *   基于虚拟网卡（TUN）构建纯净的三层 IP 网络。
    *   设备间尽可能建立 P2P 直连，降低延迟。
*   **分布式服务网格 (Service Mesh)**:
    *   **去中心化共享**: 任意节点均可声明自己局域网内的 IP 和端口（例如：`192.168.1.50:80`）。
    *   **自动路由**: 其他节点收到声明后，会自动拦截发往该 IP 的流量并路由到目标节点。
*   **UDP 服务发现与穿透**:
    *   支持 **mDNS (Bonjour)** 和 **SSDP** 协议。
    *   支持跨网段发现局域网设备（如打印机、Chromecast、Apple TV）。
    *   支持 UDP 游戏联机和语音通话。
*   **TCP 支持 (SOCKS5 隧道)**:
    *   内置 **SOCKS5 代理服务器**（默认端口 1080）。
    *   完美支持 SSH、HTTP/HTTPS 等 TCP 应用的跨网访问。
    *   *注：由于 Windows 网络栈限制，TCP 暂不支持通过虚拟网卡直接透明传输，需配置代理。*
*   **动态服务更新**:
    *   无需断开连接，运行时即可动态添加或删除共享服务。
    *   配置变更即时推送到全网所有节点。
*   **智能路由管理**:
    *   自动接管操作系统路由表 (`route add/delete`)。
    *   智能判断流量去向，不影响非 VPN 流量。
*   **跨平台支持**:
    *   Windows (x64/arm64)
    *   macOS & Linux (核心逻辑已适配)

### 2.5 平台差异与功能实现对比

| 功能模块 | Windows 状态 | macOS 状态 | Linux 状态 |
| :--- | :---: | :---: | :---: |
| **P2P Mesh 组网 (核心)** | ✅ 已实现 | ✅ 已实现 | ✅ 已实现 |
| **虚拟网卡 (TUN) 驱动** | ✅ Wintun 驱动 | ✅ utun 设备 | ⚠️ 核心支持 (GUI 待完善) |
| **SOCKS5 代理服务器** | ✅ 已实现 | ✅ 已实现 | ✅ 已实现 |
| **系统代理自动配置** | ✅ 注册表修改 | ✅ `networksetup` | ❌ 待实现 |
| **权限自动提升 (Root)** | ✅ UAC 弹窗 | ✅ `sudo` 重启逻辑 | ❌ 待实现 |
| **主机名自动获取** | ✅ `COMPUTERNAME` | ✅ `scutil` 名称 | ✅ `HOSTNAME` |
| **分布式服务声明 (Gateway)** | ✅ 已实现 | ✅ 已实现 | ✅ 已实现 |
| **UDP 广播/多播反射** | ✅ 已实现 | ⚠️ 基础支持 | ❌ 待实现 |
| **透明 TCP (Raw TCP)** | ❌ 待实现 | ❌ 待实现 | ❌ 待实现 |

#### 平台特性说明
- **Windows**: 使用高性能 Wintun 驱动，支持注册表自动同步系统代理设置。
- **macOS**: 支持通过 `sudo` 自动提升权限，支持通过 `scutil` 获取设备友好名称，使用 `networksetup` 同步代理设置。
- **Linux**: 目前以核心库支持为主，高级系统集成功能（如代理设置、权限管理）仍在完善中。

### 🚧 待实现/计划中功能

*   **Raw TCP NAT**: 实现无需 SOCKS5 代理的透明 TCP 直连（目前需配合代理使用）。
*   **DNS 解析**: 支持 VPN 内置 DNS，实现通过域名访问服务。
*   **移动端 App**: Android 和 iOS 客户端。
*   **GUI 高级设置**: 可视化配置 SOCKS5 端口、日志级别等。
*   **文件传输优化**: 针对大文件的断点续传和 P2P 加速。

---

## 3. 操作与设置指南

### 3.1 快速开始
1.  **启动**: 双击运行程序。
    *   *注意*: Windows 上会自动弹出 UAC 提示，请务必点击“是”以授予管理员权限（用于创建虚拟网卡）。
2.  **登录**: 使用邮箱/密码注册并登录。
3.  **一键连接**: 点击首页的“一键连接”按钮。
4.  **连接成功**: 图标变绿，显示分配的虚拟 IP（如 `10.10.0.x`）。

### 3.2 共享局域网服务
假设您想在家中访问公司电脑（安装了 Syuink）所在局域网的 **打印机 (192.168.1.100)** 和 **Web 服务器 (192.168.1.50)**。

1.  在 **公司电脑** 上打开 Syuink。
2.  点击首页的 **“共享服务”** 展开面板。
3.  添加服务：
    *   **IP**: `192.168.1.100`, **Port**: `9100`, **协议**: `TCP/UDP`, **类型**: `打印机`。
    *   **IP**: `192.168.1.50`, **Port**: `80`, **协议**: `TCP`, **类型**: `通用`。
4.  点击 `+` 号保存。此时，家中的电脑（已连接 Syuink）会自动更新路由表。

### 3.3 访问服务

#### A. 访问 UDP 服务 (打印机/投屏/游戏)
*   **直接使用**: Syuink 会自动处理 UDP 广播和单播。
*   例如：在 Windows“添加打印机”中直接搜索，或者在游戏中直接输入 IP `192.168.1.100`。

#### B. 访问 TCP 服务 (SSH/Web/NAS)
由于 TCP 协议的特殊性，需配合 **SOCKS5 代理** 使用：

1.  **查看代理信息**: 在 Syuink 首页可见 `SOCKS5 代理: 127.0.0.1:1080`。
2.  **SSH 连接**:
    ```bash
    ssh -o ProxyCommand="ncat --proxy-type socks5 --proxy 127.0.0.1:1080 %h %p" user@192.168.1.50
    ```
    *(或者在 PuTTY/Xshell 的代理设置中配置 SOCKS5)*
3.  **浏览器访问 (Web)**:
    *   安装 Chrome 插件 **Proxy SwitchyOmega**。
    *   新建情景模式，协议选 `SOCKS5`，代理服务器 `127.0.0.1`，端口 `1080`。
    *   启用该模式后，访问 `http://192.168.1.50` 即可直达公司内网。

### 3.4 全局代理模式
如果您希望所有流量都通过 VPN（例如访问互联网）：
1.  右键点击系统托盘图标。
2.  选择 **代理规则** -> **全局**。
3.  此时系统所有流量将通过 SOCKS5 代理转发（需自行配置系统代理指向 `127.0.0.1:1080` 或使用支持全局代理的工具）。

### 3.5 常见问题排查 (Troubleshooting)
*   **无法启动/报错 "Channel closed"**:
    *   检查是否以管理员权限运行。
    *   检查目录下是否存在 `wintun.dll`。
*   **连接超时**:
    *   检查防火墙是否放行了 UDP 流量。
    *   尝试更换信令服务器地址。
*   **Ping 不通**:
    *   Syuink 默认拦截 ICMP 包，如果对方防火墙禁用了 Ping，则无法 Ping 通，但这不代表服务不可用。请直接尝试 telnet 端口。

---

## 4. 技术实现原理

### 4.1 核心架构
Syuink 采用 **Rust (`p2p-node`)** 作为核心网络引擎，前端使用 **React + Tauri v2** 构建。

*   **虚拟网络**: 使用 `tun` crate 创建虚拟网卡，拦截操作系统流量。
*   **信令系统**: WebSocket 服务端协调节点发现、握手（SDP）和服务声明广播。

### 4.2 流量转发机制

#### UDP 流量 (透明 NAT)
1.  **捕获**: 虚拟网卡收到发往 `192.168.1.x` 的 UDP 包。
2.  **封装**: `GatewayRouter` 查找路由表，定位目标 Peer ID。
3.  **传输**: 将原始数据包封装为 `TunPacket`，通过 P2P 通道发送。
4.  **还原**: 目标节点解包，使用 **用户态 NAT** 记录映射关系，并通过物理网卡转发给真实设备。
5.  **回包**: 真实设备回包 -> 目标节点 NAT 匹配 -> 封装回传 -> 源节点虚拟网卡。

#### TCP 流量 (SOCKS5 隧道)
由于 Windows 内核网络栈的限制，Raw TCP 还原极为复杂。我们采用了更稳定高效的应用层代理方案：

1.  **拦截**: 本地监听 `127.0.0.1:1080`。
2.  **握手**: 客户端发起 SOCKS5 CONNECT 请求（如连接 `192.168.1.50:80`）。
3.  **路由**: Syuink 检查该 IP 是否属于某个 Peer 的共享服务。
4.  **隧道建立**: 发送 `TcpConnect` 信令给目标 Peer。
5.  **数据泵**:
    *   本地 SOCKS5 连接 <-> 信令通道 (`TcpData`) <-> 目标节点。
    *   目标节点作为“跳板机”，发起真实的 TCP 连接到 `192.168.1.50:80`。

#### 广播反射 (Broadcast Reflector)
为了实现 mDNS (打印机发现/AirPlay)，Syuink 运行一个反射器：
1.  **监听**: 监听物理网卡的 `224.0.0.251:5353` 和 `239.255.255.250:1900`。
2.  **注入**: 收到局域网多播包后，将其源 IP 伪装，注入到虚拟网络中。
3.  **效果**: 远端设备的虚拟网卡会收到这些多播包，从而认为设备在同一局域网内。
